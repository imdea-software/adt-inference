%!TEX root = draft.tex
\section{A Symbolic ADT Inference Algorithm}
\label{sec:algorithm}

Algorithm~\ref{alg:inference} lists the algorithm for solving the symbolic ADT
inference problem which is based on the relation $\preceq$ defined in
Section~\ref{sec:patterns}. The algorithm performs an weight-increasing
enumeration of $B$ while maintaining the $\preceq$-minimal elements, and stops
whenever no new minimals are found at a given weight.

\begin{algorithm}[t]
  \SetAlgoLined
  \SetKwInOut{Input}{Input}
  \Input{A reference implementation $\mathcal{I}$}
  \KwResult{A formula representing the ADT of $\mathcal{I}$}
  weight $\gets$ $0$ \;
  patterns $\gets$ $\emptyset$ \;
  \Repeat{$B_\text{weight} = B_{\text{weight}-1}$}{
    weight $\gets$ weight + $1$ \;
    patterns $\gets$ $\min B_\text{weight}$ \;
  }
  \Return $F(\text{patterns})$
  \caption{Symbolic ADT inference.}
  \label{alg:inference}
\end{algorithm}

The partial correctness of Algorithm~\ref{alg:inference} (i.e.,~ignoring
termination) relies on the input ADT being \emph{predictable}, i.e.,~for all
$i \in \mathbb{N}$,
\begin{align*}
  B_{i+1} \succeq \min \bigcup_{0 < j \le i} b_j
  \text{ implies } \min B = \min \bigcup_{0 < j \le i} b_j
\end{align*}
Section~\ref{sec:nature} shows that many naturally-occurring ADTs are predictable.

\begin{theorem}
  \label{thm:algorithm}

  Algorithm~\ref{alg:inference} terminates. If the input implementationâ€™s
  ADT is predictable, then the returned formula represents it.

\end{theorem}

\begin{proof}
  Termination is a direct consequence of Lemma~\ref{lem:wqo}, and since the
  number of histories of any weight $i \in \mathbb{N}$ is finite\footnote{
    As noted in Section~\ref{sec:histories}, we consider equality between
    histories up to renaming of operation identifiers.
  }
  each $B_i$ is computable.

  Furthermore, when $A$ is predictable, we
  have $B \subseteq \text{patterns}^+$, where $\text{patterns}^+$ is the
  upward closure of $\text{patterns}$ under $\preceq$. Thus by
  Lemma~\ref{lem:formula1}, the returned formula represents $A$.
\end{proof}

Note that for non-predictable ADTs, the value of $\text{patterns}^+$ upon
termination of Algorithm~\ref{alg:inference} is an under-approximation of the
bounded ADT complement $B$. The resulting symbolic ADT representation is still
satisfied by all histories in $A$, therefore it would still be sound for modular
program reasoning, identifying only actual violations, and implying the
correctness of client programs which do not depend on the stronger criteria
which excludes unidentified violations. However, the under-approximation may be
incomplete in identifying all violations, and in proving client programs which
depend on the stronger criteria which excludes them all.
